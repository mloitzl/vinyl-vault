name: Test

on:
  push:
    branches:
      - '**'
  workflow_call:

jobs:
    test-frontend:
        name: Frontend Tests
        runs-on: self-hosted
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Print pnpm and lockfile info
              run: |
                  pnpm --version
                  head -20 pnpm-lock.yaml || echo "pnpm-lock.yaml not found at repo root"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run frontend tests
              run: pnpm --filter frontend test --run

    test-backend:
        name: Backend Tests
        runs-on: self-hosted
        services:
            mongodb:
                image: mongo:4.4.6
                ports:
                    - 27018:27017
                options: >-
                    --health-cmd="mongo --quiet --eval 'db.runCommand({ ping: 1 })'"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=15
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Print pnpm and lockfile info
              run: |
                  pnpm --version
                  head -20 pnpm-lock.yaml || echo "pnpm-lock.yaml not found at repo root"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run backend tests
              env:
                  MONGODB_URI_BASE: mongodb://localhost:27018
              run: pnpm --filter backend test --run

            - name: Backend test status
              if: failure()
              run: |
                  echo "Backend tests failed"
                  echo "Consider inspecting MongoDB service logs"
            - name: Print MongoDB container logs on failure
              if: failure()
              run: |
                  docker logs $(docker ps -q --filter ancestor=mongo:4.4.6) || true

    test-bff:
        name: BFF Tests
        runs-on: self-hosted
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Print pnpm and lockfile info
              run: |
                  pnpm --version
                  head -20 pnpm-lock.yaml || echo "pnpm-lock.yaml not found at repo root"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run BFF tests
              run: pnpm --filter bff test --run

    test-summary:
        name: Test Summary
        runs-on: self-hosted
        needs: [test-frontend, test-backend, test-bff]
        if: always()
        permissions:
            pull-requests: write

        steps:
            - name: Check test results
              run: |
                  if [[ "${{ needs.test-frontend.result }}" == "success" && "${{ needs.test-backend.result }}" == "success" && "${{ needs.test-bff.result }}" == "success" ]]; then
                    echo "✅ All tests passed"
                  else
                    echo "❌ One or more test suites failed"
                    echo "Frontend: ${{ needs.test-frontend.result }}"
                    echo "Backend: ${{ needs.test-backend.result }}"
                    echo "BFF: ${{ needs.test-bff.result }}"
                    exit 1
                  fi

            - name: Post test summary comment
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const frontendStatus = '${{ needs.test-frontend.result }}' === 'success' ? '✅' : '❌';
                      const backendStatus = '${{ needs.test-backend.result }}' === 'success' ? '✅' : '❌';
                      const bffStatus = '${{ needs.test-bff.result }}' === 'success' ? '✅' : '❌';

                      const body = [
                        '## Test Results',
                        '',
                        `${frontendStatus} Frontend Tests: **${{ needs.test-frontend.result }}**`,
                        `${backendStatus} Backend Tests: **${{ needs.test-backend.result }}**`,
                        `${bffStatus} BFF Tests: **${{ needs.test-bff.result }}**`,
                        '',
                        '_All tests are required to pass._'
                      ].join('\\n');

                      // Find existing comment
                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const botComment = comments.find(comment => 
                        comment.user.type === 'Bot' && 
                        comment.body.includes('## Test Results')
                      );

                      if (botComment) {
                        // Update existing comment
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: botComment.id,
                          body
                        });
                      } else {
                        // Create new comment
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body
                        });
                      }
