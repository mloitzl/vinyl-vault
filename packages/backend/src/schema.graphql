# Domain Backend GraphQL Schema

type Query {
  """
  Get a user by ID.
  """
  user(id: ID!): User

  """
  Get a record by ID.
  """
  record(id: ID!): Record

  """
  Get a release by ID.
  """
  release(id: ID!): Release

  """
  Search releases by barcode.
  """
  releasesByBarcode(barcode: String!): [Release!]!

  """
  List records with pagination and filtering.
  """
  records(userId: ID, first: Int, after: String, filter: RecordFilter): RecordConnection!

  """
  Get all tenants for a user (including their role in each tenant).
  """
  userTenants(userId: ID!): [UserTenantRole!]!
}

type Mutation {
  """
  Look up a barcode and return matching releases.
  If not cached, fetches from external APIs.
  """
  lookupBarcode(barcode: String!): LookupBarcodePayload!

  """
  Create a new record.
  """
  createRecord(input: CreateRecordInput!): Record!

  """
  Update a record.
  """
  updateRecord(input: UpdateRecordInput!): Record!

  """
  Delete a record.
  """
  deleteRecord(id: ID!): Boolean!

  """
  Create or update a user from GitHub data.
  """
  upsertUser(input: UpsertUserInput!): User!

  """
  Create a new tenant (personal or organization).
  """
  createTenant(input: CreateTenantInput!): Tenant!

  """
  Add a user to a tenant with a specific role.
  """
  addUserToTenant(userId: ID!, tenantId: String!, role: TenantRole!): UserTenantRole!

  """
  Handle GitHub installation webhook payloads forwarded by the BFF.
  Validates the signature and stores installation metadata in the registry database.
  """
  handleGitHubInstallationWebhook(
    input: GitHubInstallationWebhookInput!
  ): GitHubInstallationWebhookResult!

  """
  Complete GitHub App installation setup: link user to installation and create org tenant.
  Called after user is redirected from GitHub post-installation.
  Requires authenticated user (BFF validates session).
  """
  completeInstallationSetup(
    input: CompleteInstallationSetupInput!
  ): CompleteInstallationSetupResult!
}

type User {
  id: ID!
  githubId: String!
  githubLogin: String!
  displayName: String!
  avatarUrl: String
  email: String
  role: UserRole!
  createdAt: String!
  updatedAt: String!
  records: [Record!]!
}

"""
User role in the application.
- ADMIN: Full control over the application and all tenants
- MEMBER: Can create and manage their own content
- VIEWER: Read-only access
"""
enum UserRole {
  ADMIN
  MEMBER
  VIEWER
}

type Record {
  id: ID!
  release: Release!
  owner: User!
  purchaseDate: String
  price: Float
  condition: String
  location: String
  notes: String
  createdAt: String!
  updatedAt: String!
}

type Release {
  id: ID!
  barcode: String!
  artist: String!
  title: String!
  year: Int
  format: String
  genre: [String!]
  style: [String!]
  label: String
  country: String
  coverImageUrl: String
  trackList: [Track!]
  externalId: String
  source: ReleaseSource!
  createdAt: String!
  updatedAt: String!
}

type Track {
  position: String
  title: String!
  duration: String
}

enum ReleaseSource {
  DISCOGS
  MUSICBRAINZ
  MANUAL
}

"""
Tenant type: USER (personal) or ORGANIZATION (shared).
"""
enum TenantType {
  USER
  ORGANIZATION
}

"""
User role within a tenant: ADMIN, MEMBER, or VIEWER.
"""
enum TenantRole {
  ADMIN
  MEMBER
  VIEWER
}

"""
A tenant (personal or organization collection).
"""
type Tenant {
  """
  Unique tenant identifier (user_{userId} or org_{orgId}).
  """
  tenantId: String!

  """
  Type of tenant: USER or ORGANIZATION.
  """
  tenantType: TenantType!

  """
  Display name (user display name or organization name).
  """
  name: String!

  """
  Database name for this tenant.
  """
  databaseName: String!

  """
  When the tenant was created.
  """
  createdAt: String!
}

"""
A user's role in a specific tenant.
"""
type UserTenantRole {
  """
  User ID (MongoDB ObjectId as string).
  """
  userId: ID!

  """
  Tenant identifier.
  """
  tenantId: String!

  """
  User's role in this tenant: ADMIN, MEMBER, or VIEWER.
  """
  role: TenantRole!

  """
  Tenant type: USER or ORGANIZATION.
  """
  tenantType: TenantType!

  """
  Tenant display name.
  """
  name: String!

  """
  Tenant database name.
  """
  databaseName: String!

  """
  When the role was created.
  """
  createdAt: String!
}

"""
Input for creating a new tenant.
"""
input CreateTenantInput {
  """
  Type of tenant to create: USER or ORGANIZATION.
  """
  tenantType: TenantType!

  """
  Display name for the tenant.
  """
  name: String!

  """
  GitHub organization ID (for ORGANIZATION tenants only).
  """
  githubOrgId: String

  """
  GitHub organization name (for ORGANIZATION tenants only).
  """
  githubOrgName: String
}

type RecordConnection {
  edges: [RecordEdge!]!
  pageInfo: PageInfo!
  totalCount: Int!
}

type RecordEdge {
  cursor: String!
  node: Record!
}

type PageInfo {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}

input RecordFilter {
  artist: String
  title: String
  year: Int
  format: String
  location: String
  search: String
}

input CreateRecordInput {
  releaseId: ID!
  purchaseDate: String
  price: Float
  condition: String
  location: String
  notes: String
}

input UpdateRecordInput {
  id: ID!
  purchaseDate: String
  price: Float
  condition: String
  location: String
  notes: String
}

input UpsertUserInput {
  githubId: String!
  githubLogin: String!
  displayName: String!
  avatarUrl: String
  email: String
}

"""
Result of a barcode lookup using the blended scoring approach.
"""
type LookupBarcodePayload {
  """
  Aggregated albums derived from releases across all sources.
  Each album represents a unique normalized artist+title combination.
  Albums are sorted by the score of their primary release (highest first).
  """
  albums: [Album!]!

  """
  Legacy field: flat list of releases for backward compatibility.
  @deprecated Use albums instead for the full scoring and grouping benefits.
  """
  releases: [Release!]! @deprecated(reason: "Use albums instead")

  """
  Whether the result was served from cache.
  """
  fromCache: Boolean!

  """
  Timing information for performance analysis.
  """
  timing: LookupTiming

  """
  Errors encountered during lookup (non-fatal).
  The lookup may still return partial results.
  """
  errors: [String!]
}

"""
An aggregated album combining data from multiple release sources.
Implements FR-AG-* requirements.
"""
type Album {
  """
  Unique album identifier (hash of normalized artist + title).
  """
  id: ID!

  """
  Normalized artist name (main artist, articles removed).
  """
  artist: String!

  """
  Normalized album title (parentheticals and articles removed).
  """
  title: String!

  """
  List of barcode(s) that match this album.
  """
  barcodes: [String!]!

  """
  The primary release selected by highest score.
  """
  primaryRelease: ScoredRelease!

  """
  All alternative releases for this album, sorted by score descending.
  """
  alternativeReleases: [AlternativeRelease!]!

  """
  Best available track list from highest-scoring release with tracks.
  """
  trackList: [Track!]

  """
  Aggregated genres from all releases (deduplicated).
  """
  genres: [String!]!

  """
  Aggregated styles from all releases (deduplicated).
  """
  styles: [String!]!

  """
  All external IDs grouped by source.
  """
  externalIds: ExternalIds!

  """
  Best available cover image URL.
  """
  coverImageUrl: String

  """
  Other title variations found (e.g., remasters, editions).
  """
  otherTitles: [String!]!

  """
  Edition notes collected from releases (e.g., "Remastered", "Deluxe").
  """
  editionNotes: [String!]!

  """
  Number of releases that were grouped into this album.
  """
  releaseCount: Int!

  """
  Score of the primary release (for sorting/display).
  """
  score: Int!
}

"""
A release with its scoring information.
"""
type ScoredRelease {
  """
  Original release data.
  """
  release: Release!

  """
  Total score calculated by the scoring algorithm.
  """
  score: Int!

  """
  Detailed breakdown of how the score was calculated.
  """
  scoreBreakdown: ScoreBreakdown!
}

"""
Score breakdown showing points from each scoring factor.
Implements FR-SC-* requirements for traceability.
"""
type ScoreBreakdown {
  """
  Points from media type preference (FR-SC-1).
  """
  mediaType: Int!

  """
  Points from country preference (FR-SC-2).
  """
  countryPreference: Int!

  """
  Points from track list completeness (FR-SC-3).
  """
  trackListCompleteness: Int!

  """
  Points from cover art availability.
  """
  coverArt: Int!

  """
  Points from label information.
  """
  labelInfo: Int!

  """
  Points from catalog number.
  """
  catalogNumber: Int!

  """
  Points from year information.
  """
  yearInfo: Int!

  """
  Points from source bonus (e.g., Discogs base bonus).
  """
  sourceBonus: Int!
}

"""
An alternative release for an album (simplified view).
"""
type AlternativeRelease {
  """
  External ID from the source.
  """
  externalId: String!

  """
  Source of this release.
  """
  source: ReleaseSource!

  """
  Country of release.
  """
  country: String

  """
  Year of release.
  """
  year: Int

  """
  Format/media type.
  """
  format: String

  """
  Label name.
  """
  label: String

  """
  Score for this release.
  """
  score: Int!

  """
  Edition notes if any.
  """
  editionNote: String
}

"""
External IDs from various sources.
"""
type ExternalIds {
  discogs: [String!]!
  musicbrainz: [String!]!
}

"""
Timing information for performance analysis.
"""
type LookupTiming {
  """
  Time spent fetching from Discogs (ms).
  """
  discogsMs: Int!

  """
  Time spent fetching from MusicBrainz (ms).
  """
  musicbrainzMs: Int!

  """
  Time spent on scoring and aggregation (ms).
  """
  scoringMs: Int!

  """
  Total lookup time (ms).
  """
  totalMs: Int!
}

input GitHubInstallationWebhookInput {
  """
  Base64-encoded raw webhook payload to preserve signature integrity.
  """
  payloadBase64: String!

  """
  X-Hub-Signature-256 header value from GitHub.
  """
  signature: String!
}

type GitHubInstallationWebhookResult {
  ok: Boolean!
  message: String
}

input CompleteInstallationSetupInput {
  """
  User ID (from BFF session, already authenticated).
  """
  userId: String!

  """
  Installation ID from GitHub.
  """
  installationId: Int!

  """
  Setup action (e.g., 'install').
  """
  setupAction: String
}

type CompleteInstallationSetupResult {
  ok: Boolean!
  tenantId: String!
  tenantName: String!
  message: String
}
